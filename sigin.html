<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Se connecter - Jouez votre mélodie</title>
    <link rel="stylesheet" href="sign.css"> </head>
<body class="signin-page">
<div class="container">
    <h1>Connexion</h1>

    <form id="signinForm">
        <div class="form-group">
            <label for="username">Nom d'utilisateur</label>
            <input type="text" id="username" required>
        </div>

        <div class="form-group">
            <label>Rejouez votre mélodie secrète</label>
            <p class="info">Jouez la même séquence que lors de votre inscription</p>

            <div class="melody-display" id="melodyDisplay">
                <span class="placeholder">Aucune note jouée</span>
            </div>

            <div class="piano" id="piano">
                <div class="key white" data-note="C" data-key="a">
                    <span>A</span>
                    <span class="note-name">Do</span>
                </div>
                <div class="key black" data-note="C#" data-key="z">
                    <span>Z</span>
                </div>
                <div class="key white" data-note="D" data-key="e">
                    <span>E</span>
                    <span class="note-name">Ré</span>
                </div>
                <div class="key black" data-note="D#" data-key="r">
                    <span>R</span>
                </div>
                <div class="key white" data-note="E" data-key="t">
                    <span>T</span>
                    <span class="note-name">Mi</span>
                </div>
                <div class="key white" data-note="F" data-key="y">
                    <span>Y</span>
                    <span class="note-name">Fa</span>
                </div>
                <div class="key black" data-note="F#" data-key="u">
                    <span>U</span>
                </div>
                <div class="key white" data-note="G" data-key="i">
                    <span>I</span>
                    <span class="note-name">Sol</span>
                </div>
                <div class="key black" data-note="G#" data-key="o">
                    <span>O</span>
                </div>
                <div class="key white" data-note="A" data-key="p">
                    <span>P</span>
                    <span class="note-name">La</span>
                </div>
                <div class="key black" data-note="A#" data-key="q">
                    <span>Q</span>
                </div>
                <div class="key white" data-note="B" data-key="s">
                    <span>S</span>
                    <span class="note-name">Si</span>
                </div>
            </div>

            <div class="controls">
                <button type="button" id="clearMelody" class="btn-secondary">Effacer</button>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>

        <button type="submit" id="submitBtn">Se connecter</button>
    </form>

    <p class="footer-link">Pas encore de compte ? <a href="signup.html">S'inscrire</a></p>
</div>

<script>
    // Le code JavaScript pour la connexion reste inchangé et est fonctionnel.
    const notes = {
        'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
        'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
        'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
    };

    let melody = [];
    const melodyDisplay = document.getElementById('melodyDisplay');
    const errorMessage = document.getElementById('errorMessage');
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    function playNote(frequency, duration = 0.3) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    }

    function addNote(note) {
        melody.push(note);
        updateDisplay();
        playNote(notes[note]);
        errorMessage.style.display = 'none';
    }

    function updateDisplay() {
        if (melody.length === 0) {
            melodyDisplay.innerHTML = '<span class="placeholder">Aucune note jouée</span>';
        } else {
            melodyDisplay.innerHTML = melody.map(note =>
                `<span class="note-chip">${note}</span>`
            ).join('');
        }
    }

    document.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        const pianoKey = document.querySelector(`[data-key="${key}"]`);

        if (pianoKey && !e.repeat) {
            const note = pianoKey.dataset.note;
            pianoKey.classList.add('active');
            addNote(note);
        }
    });

    document.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        const pianoKey = document.querySelector(`[data-key="${key}"]`);

        if (pianoKey) {
            pianoKey.classList.remove('active');
        }
    });

    document.querySelectorAll('.key').forEach(key => {
        key.addEventListener('click', () => {
            const note = key.dataset.note;
            key.classList.add('active');
            addNote(note);
            setTimeout(() => key.classList.remove('active'), 200);
        });
    });

    document.getElementById('clearMelody').addEventListener('click', () => {
        melody = [];
        updateDisplay();
        errorMessage.style.display = 'none';
    });

    function verifyMelody(username, inputMelody) {
        const userData = localStorage.getItem('user_' + username);

        if (!userData) {
            return { success: false, message: 'Utilisateur introuvable' };
        }

        const user = JSON.parse(userData);
        const correctMelody = user.melody;

        if (inputMelody.length !== correctMelody.length) {
            return { success: false, message: 'Mélodie incorrecte (nombre de notes différent)' };
        }

        for (let i = 0; i < inputMelody.length; i++) {
            if (inputMelody[i] !== correctMelody[i]) {
                return { success: false, message: 'Mélodie incorrecte' };
            }
        }

        return { success: true };
    }

    document.getElementById('signinForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value;

        if (melody.length === 0) {
            errorMessage.textContent = 'Veuillez jouer votre mélodie';
            errorMessage.style.display = 'block';
            return;
        }

        const result = verifyMelody(username, melody);

        if (result.success) {
            alert('Connexion réussie ! Bienvenue ' + username);
            window.location.href = 'index.html';
        } else {
            errorMessage.textContent = result.message;
            errorMessage.style.display = 'block';

            document.querySelectorAll('.note-chip').forEach(chip => {
                chip.style.background = 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)';
            });

            setTimeout(() => {
                melody = [];
                updateDisplay();
            }, 1000);
        }
    });
</script>
</body>
</html>